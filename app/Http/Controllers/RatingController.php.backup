<?php

namespace App\Http\Controllers;

use App\Models\Rating;
use App\Models\Partido;
use App\Models\Inscripcion;
use App\Models\Estadistica;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;

class RatingController extends Controller
{
    public function store(Request $request)
    {
        $request->validate([
            'calificado_id' => 'required|integer|exists:users,id',
            'partido_id' => 'required|integer|exists:partidos,id',
            'tipo_calificacion' => 'required|in:comportamiento_competitivo,toma_decisiones,impacto_resultado,capacidad_defensiva,eficacia,participacion_juego',
            'puntuacion' => 'required|integer|min:1|max:3',
            'tipo' => 'required|in:jugador,arbitro',
        ]);

        $calificador = Auth::user();
        $partido = Partido::findOrFail($request->partido_id);

        // Verificar que el partido esté finalizado
        if ($partido->estado !== 'finalizado') {
            return response()->json(['message' => 'Solo puedes calificar partidos finalizados'], 403);
        }

        // Verificar permisos según tipo
        if ($request->tipo === 'arbitro') {
            // Solo jugadores del partido pueden calificar al árbitro
            $esJugadorDelPartido = Inscripcion::where('partido_id', $request->partido_id)
                ->where('jugador_id', $calificador->id)
                ->where('estado', 'confirmado')
                ->exists();
            if (!$esJugadorDelPartido) {
                return response()->json(['message' => 'No puedes calificar a este árbitro'], 403);
            }
        } elseif ($request->tipo === 'jugador') {
            // Solo jugadores del partido pueden calificar a otros jugadores
            $esJugadorDelPartido = Inscripcion::where('partido_id', $request->partido_id)
                ->where('jugador_id', $calificador->id)
                ->where('estado', 'confirmado')
                ->exists();
            if (!$esJugadorDelPartido) {
                return response()->json(['message' => 'No puedes calificar en este partido'], 403);
            }

            // No puede calificar a sí mismo
            if ($request->calificado_id === $calificador->id) {
                return response()->json(['message' => 'No puedes calificar a ti mismo'], 403);
            }

            // Verificar que el calificado también jugó en el partido
            $calificadoJugo = Inscripcion::where('partido_id', $request->partido_id)
                ->where('jugador_id', $request->calificado_id)
                ->where('estado', 'confirmado')
                ->exists();
            if (!$calificadoJugo) {
                return response()->json(['message' => 'El jugador calificado no participó en este partido'], 403);
            }
        }

        // Verificar que no haya calificado ya este tipo para este jugador en este partido
        $yaCalificado = Rating::where('partido_id', $request->partido_id)
            ->where('calificador_id', $calificador->id)
            ->where('calificado_id', $request->calificado_id)
            ->where('tipo_calificacion', $request->tipo_calificacion)
            ->exists();

        if ($yaCalificado) {
            return response()->json(['message' => 'Ya has calificado este aspecto para este jugador'], 403);
        }

        $rating = Rating::create([
            'calificador_id' => $calificador->id,
            'calificado_id' => $request->calificado_id,
            'partido_id' => $request->partido_id,
            'tipo' => $request->tipo,
            'tipo_calificacion' => $request->tipo_calificacion,
            'puntuacion' => $request->puntuacion,
        ]);

        // Actualizar estadísticas si es calificación a jugador
        if ($request->tipo === 'jugador') {
            $estadistica = Estadistica::firstOrCreate(['jugador_id' => $request->calificado_id]);
            $estadistica->agregarCalificacion($request->tipo_calificacion, $request->puntuacion);
        }

        return response()->json(['message' => 'Calificación guardada', 'rating' => $rating]);
    }
            eputiupc_cnalificacion', $puesutc>tnipo_calificacion)
        -
        if ($yaCalificado) {
            return response()->json(['message' => 'Ya has calificado este aspecto para este jugador'], 403);
        }===

        $ratiesnRdtscecateagreg[r_oalificador-
            'calificado_id' => $request->calificado_id,
            'partido_id' => $request->partido_id,
            'tipo' => $request->tipo,
            'tipo_calificacion' => $request->tipo_calificacion,
            'puntuacion' => $request->puntuacion,
        ]);

        // Actualizar estadísticas si es calificación a jugador
        if ($request->tipo === 'jugador') {
            $estadistica = Estadistica::firstOrCreate(['jugador_id' => $request->calificado_id]);
            $estadistica->agregarCalificacion($request->tipo_calificacion, $request->puntuacion);
        }

        return response()->json(['message' => 'Calificación guardada', 'rating' => $rating]);
    }

    public function show($partidoId)
    {
        $partido = Partido::with(['jugadores', 'arbitro'])->findOrFail($partidoId);
        $jugador = Auth::user();

        // Verificar si puede calificar
        $puedeCalificar = Inscripcion::where('partido_id', $partidoId)
            ->where('jugador_id', $jugador->id)
            ->exists() || $partido->arbitro_id === $jugador->id;
    }

    public function partidosEnMarcha()
    {
        $usuario = Auth::user();

        // Partidos en curso: partidos que han iniciado según el horario pero no han terminado
        $partidosEnMarcha = Partido::where('estado', 'en_curso')
            ->whereHas('inscripciones', function ($query) use ($usuario) {
                $query->where('jugador_id', $usuario->id)
                      ->where('estado', 'confirmado');
            })
            ->with(['arbitro', 'inscripciones' => function ($query) {
                $query->where('estado', 'confirmado');
            }])
            ->orderBy('fecha_hora', 'asc')
            ->get();

        return view('jugador.partidos', compact('partidosEnMarcha'));
    }

    public function partidosFinalizados()
    {
        $usuario = Auth::user();

        // Partidos finalizados: partidos terminados donde el usuario participó
        $partidosFinalizados = Partido::where('estado', 'finalizado')
            ->whereHas('inscripciones', function ($query) use ($usuario) {
                $query->where('jugador_id', $usuario->id)
                      ->where('estado', 'confirmado');
            })
            ->with(['arbitro', 'inscripciones' => function ($query) {
                $query->where('estado', 'confirmado');
            }])
            ->orderBy('fecha_hora', 'desc')
            ->get();

        // Para cada partido, obtener los jugadores que pueden ser calificados
        foreach ($partidosFinalizados as $partido) {
            $partido->jugadoresACalificar = $partido->inscripciones()
                ->where('estado', 'confirmado')
                ->where('jugador_id', '!=', $usuario->id)
                ->with('jugador')
                ->get()
                ->pluck('jugador');

            // Verificar si ya calificó al árbitro
            $partido->arbitroCalificado = Rating::where('partido_id', $partido->id)
                ->where('calificador_id', $usuario->id)
                ->where('tipo', 'arbitro')
                ->exists();
        }

        return view('jugador.partidos', compact('partidosFinalizados'));

        $ratings = Rating::where('partido_id', $partidoId)->get();

        return view('ratings.show', compact('partido', 'ratings', 'puedeCalificar'));
    }
    public function show($partidoId)
    {
        $partido = Partido::with(['jugadores', 'arbitro'])->findOrFail($partidoId);
        $jugador = Auth::user();

        // Verificar si puede ver calificaciones (jugó en el partido)
        $puedeVer = Inscripcion::where('partido_id', $partidoId)
            ->where('jugador_id', $jugador->id)
            ->where('estado', 'confirmado')
            ->exists();

        if (!$puedeVer) {
            abort(403, 'No tienes permiso para ver las calificaciones de este partido');
        }

        $ratings = Rating::where('partido_id', $partidoId)->get();

        return view('ratings.show', compact('partido', 'ratings', 'puedeVer'));
    }

    public function getCalificacionesUsuario($partidoId)
    {
        $usuario = Auth::user();

        $calificaciones = Rating::where('partido_id', $partidoId)
            ->where('calificador_id', $usuario->id)
            ->get()
            ->groupBy(['calificado_id', 'tipo_calificacion']);

        return response()->json($calificaciones);
    }

    private function mapTipoCalificacion($tipo)
    {
        // Este método ya no es necesario con el nuevo sistema
        // Las calificaciones ahora usan tipos específicos directamente
        return $tipo;
    }

    public function partidosEnMarchaApi()
    {
        $usuario = Auth::user();

        $partidos = Partido::where('estado', 'en_curso')
            ->whereHas('inscripciones', function ($query) use ($usuario) {
                $query->where('jugador_id', $usuario->id)
                      ->where('estado', 'confirmado');
            })
            ->with(['arbitro', 'inscripciones' => function ($query) {
                $query->where('estado', 'confirmado')
                      ->with('jugador');
            }])
            ->orderBy('fecha_hora', 'asc')
            ->get()
            ->map(function ($partido) {
                return [
                    'id' => $partido->id,
                    'nombre' => $partido->nombre,
                    'fecha_hora' => $partido->fecha_hora,
                    'ubicacion' => $partido->ubicacion,
                    'arbitro' => $partido->arbitro,
                    'jugadores_confirmados' => $partido->inscripciones->pluck('jugador'),
                    'estado' => $partido->estado,
                ];
            });

        return response()->json($partidos);
    }

    public function partidosFinalizadosApi()
    {
        $usuario = Auth::user();

        $partidos = Partido::where('estado', 'finalizado')
            ->whereHas('inscripciones', function ($query) use ($usuario) {
                $query->where('jugador_id', $usuario->id)
                      ->where('estado', 'confirmado');
            })
            ->with(['arbitro', 'inscripciones' => function ($query) {
                $query->where('estado', 'confirmado')
                      ->with('jugador');
            }])
            ->orderBy('fecha_hora', 'desc')
            ->get()
            ->map(function ($partido) {
                return [
                    'id' => $partido->id,
                    'nombre' => $partido->nombre,
                    'fecha_hora' => $partido->fecha_hora,
                    'ubicacion' => $partido->ubicacion,
                    'arbitro' => $partido->arbitro,
                    'jugadores_confirmados' => $partido->inscripciones->pluck('jugador'),
                    'estado' => $partido->estado,
                ];
            });

        return response()->json($partidos);
    }

    public function finalizarPartido(Request $request, $partidoId)
    {
        $usuario = Auth::user();
        $partido = Partido::findOrFail($partidoId);

        // Verificar permisos: admin, arbitro del partido, o creador
        if (!($usuario->hasRole('admin') ||
              ($partido->arbitro_id === $usuario->id) ||
              ($partido->creador_id === $usuario->id))) {
            return response()->json(['message' => 'No tienes permisos para finalizar este partido'], 403);
        }

        if ($partido->finalizarPartidoManual()) {
            return response()->json(['message' => 'Partido finalizado exitosamente']);
        }

        return response()->json(['message' => 'No se pudo finalizar el partido'], 400);
        return $tipo;
    }
}